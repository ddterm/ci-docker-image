name: cleanup

on:
  workflow_call:
    inputs:
      dry-run:
        description: "Don't delete images, just print messages"
        default: false
        required: false
        type: boolean

defaults:
  run:
    shell: bash

jobs:
  cleanup:
    runs-on: ubuntu-24.04
    timeout-minutes: 15

    env:
      GH_TOKEN: ${{ github.token }}
      GH_REPO: ${{ github.repository }}

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - id: keep-tags
        run: >-
          {
            echo "tags<<*EOF*";
            {
              git for-each-ref --format='%(refname:strip=3)' refs/remotes;
              git for-each-ref --format='%(refname:strip=2)' refs/tags;
              gh pr list --template '{{range .}}pr-{{.number}}{{"\n"}}{{end}}' --json number;
            } | sed -E 's/[^a-zA-Z0-9._-]+/-/g';
            echo "*EOF*";
          } | tee "$GITHUB_OUTPUT"

      - uses: amezin/container-registry-prune-action@3239b63db893af748b6cf2f35ce4ffdedb09a42e # v0.3.1
        with:
          name: ${{ github.event.repository.name }}
          tag-patterns: |
            latest
            +([0-9]).+([0-9]).+([0-9]).+([0-9])
            ${{ github.event.repository.default_branch }}
            ${{ steps.keep-tags.outputs.tags }}
          matching-tags-retention-duration: 1y
          mismatching-tags-retention-duration: 1d
          untagged-retention-duration: 1d
          dry-run: ${{ inputs.dry-run }}
